{
  String statemgrClass=Context.stateManagerClass(config);
  IStateManager statemgr=(IStateManager)Class.forName(statemgrClass).newInstance();
  statemgr.initialize(config);
  UploadRunner uploadRunner=new UploadRunner(config);
  boolean result=uploadRunner.call();
  if (!result) {
    LOG.severe("Failed to upload package. Exiting");
    statemgr.close();
    return false;
  }
  Config runtime=Config.newBuilder().put(Keys.topologyId(),topology.getId()).put(Keys.topologyName(),topology.getName()).put(Keys.topologyDefinition(),topology).put(Keys.schedulerStateManager(),new SchedulerStateManager(statemgr)).put(Keys.topologyPackageUri(),uploadRunner.getUri()).build();
  LaunchRunner launchRunner=new LaunchRunner(config,runtime);
  result=launchRunner.call();
  if (!result) {
    LOG.severe("Failed to launch topology. Attempting to roll back upload.");
    uploadRunner.undo();
    statemgr.close();
    return false;
  }
  statemgr.close();
  return true;
}
