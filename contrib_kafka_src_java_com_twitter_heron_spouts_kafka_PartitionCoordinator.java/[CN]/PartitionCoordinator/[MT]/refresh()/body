{
  LOG.info("Refreshing partition manager: " + taskIndex + " & total tasks: "+ totalTasks);
  Set<GlobalPartitionId> newAllPartitionIds=getAllPartitionsIdsFromBroker();
  LOG.debug("All partitions: " + newAllPartitionIds);
  Map<GlobalPartitionId,PartitionManager> newManagers=new HashMap<GlobalPartitionId,PartitionManager>();
  int index=0;
  for (  GlobalPartitionId id : newAllPartitionIds) {
    if (index % totalTasks == taskIndex) {
      if (managers.containsKey(id)) {
        newManagers.put(id,managers.get(id));
        LOG.debug("Old partition manager continued: " + id);
      }
 else {
        LOG.info("Adding partition manager for " + id);
        PartitionManager partitionManager=new PartitionManager(topologyInstanceId,stormConf,spoutConfig,id,storage,kafkaOffsets);
        newManagers.put(id,partitionManager);
        LOG.info("New partition manager added: " + id);
      }
    }
    index++;
  }
  for (  GlobalPartitionId id : managers.keySet()) {
    if (!newManagers.containsKey(id)) {
      managers.get(id).close();
      LOG.info("Unused partition manager closed: " + id);
    }
  }
  allPartitionIds=newAllPartitionIds;
  managers=newManagers;
}
